{
  "hash": "cd36747474356f5f2ce82855c0f8c90c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Pinus sylvestris Distribution in Europe: Climate Scenarios Mapped with R\"\ndescription: \"Create a map of the distribution of tree species under climate change scenarios\"\ndate: \"2024-06-17\"\ncategories: [forestry, ggplot2, R, spatial]\nimage: \"image.png\"\nbibliography: references.bib\nexecute: \n  warning: false\neditor_options: \n  chunk_output_type: console\n---\n\n{{< video https://www.youtube.com/watch?v=xSgVyHjEyWY&feature=youtu.be >}}\n\n\n\n\n## Introduction\n\nIn this post, we will create a map of the change of the potential distribution of *Pinus sylvestris* under two climate scenarios (RCP 4.5 and RCP 8.5) in Europe.\n\nWe will use the [EU-Trees4F dataset](https://www.nature.com/articles/s41597-022-01128-5) [@eutrees4f], a dataset with the current (2005) and future (2035, 2065, 2095) potential distribution of 67 tree species in Europe at 10 km spatial resolution. The dataset is accessible through an R package that I am developing, and it's accessible through GitHub.\n\nThe objective of this exercise is to compare the current (2005) and the future (2095) potential distribution of *Pinus sylvestris*, and determine the areas where it will maintain its distribution or absence, disappear, or expand.\n\n## Loading packages\n\nFirst of all, I will announce that I am developing a package called `{forestdata}` which gives you access to several sources to easily load forest and land cover data into R.\n\n::: callout-caution\nNote that the package is still in early development and it might be prone to errors.\n:::\n\nIn order to install the package, you need to have installed the `{remotes}` package in your system, and then you can use:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nremotes::install_github(\"Cidree/forestdata\")\n```\n:::\n\n\n\nAfter that, we can load the rest of the packages for this exercise:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pacman)\n\np_load(\n  ## Core\n  tidyverse,\n  \n  ## Donwload data\n  forestdata,\n  \n  ## Spatial data manipulation\n  terra,\n  \n  ## Visualization\n  ggtext, patchwork, tidyterra\n)\n```\n:::\n\n\n\nWe will use the `{terra}` package to manipulate the data that we download with `{forestdata}`, the `{ggtext}` package to use markdown and HTML in our plots, the `{patchwork}` package for assembling the plots, and `{tidyterra}` which makes it easy to plot `SpatRasters` in `{ggplot2}`.\n\n## Load the data\n\nThe data that we need to create the maps are:\n\n-   Current *Pinus sylvestris* potential distribution as for 2005\n\n-   Future *Pinus sylvestris* potential distribution as for 2095 under [RCP 4.5](https://en.wikipedia.org/wiki/Representative_Concentration_Pathway), a climate change scenario of intermediate emissions\n\n-   Future *Pinus sylvestris* potential distribution as for 2095 under [RCP 8.5](https://en.wikipedia.org/wiki/Representative_Concentration_Pathway), a climate change scenario o high emissions\n\nTo do so, we can use the `fd_forest_eutrees4f` function of the `{forestdata}` package as follows:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Load Pinus sylvestris data for 2005\npsylvestris_2005_sr <- fd_forest_eutrees4f(\n  species  = \"Pinus sylvestris\",\n  period   = 2005,\n  type     = \"bin\",\n  distrib  = \"pot\"\n)\n\n## Load Pinus sylvestris data for 2095 (RCP 4.5)\npsylvestris_2095_rcp45_sr <- fd_forest_eutrees4f(\n  species  = \"Pinus sylvestris\",\n  period   = 2095,\n  scenario = \"rcp45\"\n)\n\n## Load Pinus sylvestris data for 2095 (RCP 8.5)\npsylvestris_2095_rcp85_sr <- fd_forest_eutrees4f(\n  species  = \"Pinus sylvestris\",\n  period   = 2095,\n  scenario = \"rcp85\"\n)\n```\n:::\n\n\n\nThe arguments that we used are:\n\n-   `species`: Latin name of the species.\n\n-   `period`: period of the data (2005, 2035, 2065, 2095).\n\n-   `type`: the are three different types of maps. In this case we choose binary maps (1 = presence; 0 = absence). This is the option by default.\n\n-   `distrib`: type of distribution. In this case, we chose the potential distribution which is set by default.\n\n-   `scenario`: one of \"rcp45\" or \"rcp85\". When period is 2005, this argument is ignored.\n\n::: callout-tip\nThe list of possible species is available through `{forestdata}`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nforestdata::eutrees4f_species\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"Abies alba\"              \"Acer campestre\"         \n [3] \"Acer opalus\"             \"Acer platanoides\"       \n [5] \"Acer pseudoplatanus\"     \"Alnus glutinosa\"        \n [7] \"Alnus incana\"            \"Arbutus unedo\"          \n [9] \"Aria edulis\"             \"Betula pendula\"         \n[11] \"Betula pubescens\"        \"Borkhausenia intermedia\"\n[13] \"Carpinus betulus\"        \"Carpinus orientalis\"    \n[15] \"Castanea sativa\"         \"Celtis australis\"       \n[17] \"Ceratonia siliqua\"       \"Cormus domestica\"       \n[19] \"Corylus avellana\"        \"Cupressus sempervirens\" \n[21] \"Fagus sylvatica\"         \"Fraxinus angustifolia\"  \n[23] \"Fraxinus excelsior\"      \"Fraxinus ornus\"         \n[25] \"Juglans regia\"           \"Juniperus thurifera\"    \n[27] \"Larix decidua\"           \"Laurus nobilis\"         \n[29] \"Malus sylvestris\"        \"Olea europaea\"          \n[31] \"Ostrya carpinifolia\"     \"Picea abies\"            \n[33] \"Pinus brutia\"            \"Pinus cembra\"           \n[35] \"Pinus halepensis\"        \"Pinus nigra\"            \n[37] \"Pinus pinaster\"          \"Pinus pinea\"            \n[39] \"Pinus sylvestris\"        \"Pistacia lentiscus\"     \n[41] \"Pistacia terebinthus\"    \"Populus alba\"           \n[43] \"Populus nigra\"           \"Populus tremula\"        \n[45] \"Prunus avium\"            \"Prunus padus\"           \n[47] \"Pyrus communis\"          \"Quercus cerris\"         \n[49] \"Quercus coccifera\"       \"Quercus faginea\"        \n[51] \"Quercus frainetto\"       \"Quercus ilex\"           \n[53] \"Quercus petraea\"         \"Quercus pubescens\"      \n[55] \"Quercus pyrenaica\"       \"Quercus robur\"          \n[57] \"Quercus suber\"           \"Robinia pseudoacacia\"   \n[59] \"Salix alba\"              \"Sorbus aucuparia\"       \n[61] \"Taxus baccata\"           \"Tilia cordata\"          \n[63] \"Tilia platyphyllos\"      \"Torminalis glaberrima\"  \n[65] \"Ulmus glabra\"            \"Ulmus laevis\"           \n[67] \"Ulmus minor\"            \n```\n\n\n:::\n:::\n\n\n:::\n\nWe can see how one of these rasters look like:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npsylvestris_2095_rcp85_sr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 410, 400, 1  (nrow, ncol, nlyr)\nresolution  : 10000, 10000  (x, y)\nextent      : 2600000, 6600000, 1400000, 5500000  (xmin, xmax, ymin, ymax)\ncoord. ref. : ETRS89-extended / LAEA Europe (EPSG:3035) \nsource      : Pinus_sylvestris_ens-clim_rcp85_fut2095_bin_pot.tif \nname        : Pinus_sylvestris_ens-clim_rcp85_fut2095_bin_pot \nmin value   :                                               0 \nmax value   :                                               1 \n```\n\n\n:::\n:::\n\n\n\n## Prepare the data\n\nThe three rasters that we downloaded have two values:\n\n-   **1** = presence of *Pinus sylvestris*\n\n-   **0** = absence of *Pinus sylvestris*\n\nWe need to combine the current raster with the other two in a way that we can create the four classes:\n\n-   **Absent**: areas where *P. sylvestris* is absent, and it will still be absent\n\n-   **Will disappear**: areas where *P. sylvestris* is present, but it won't be in the future models\n\n-   **Will appear**: areas where *P. sylvestris* is absent, but it will be present in the future models\n\n-   **Present and stable**: areas where *P. sylvestris* is present, and it will still be present\n\nTo achieve this, I created the next function:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreclassify_rcp <- function(raster, classes) {\n  \n  ## Reclassify 1 for 2\n  raster_class <- ifel(\n    raster == 1, 2, raster\n  )\n  ## Sum to current (2005) distribution\n  raster_class <- as.factor(raster_class + psylvestris_2005_sr)\n  ## Rename levels\n  levels(raster_class)[[1]][, 2] <- classes\n  raster_class\n}\n```\n:::\n\n\n\nThis function will classify the input rasters (RCP 4.5 and RCP 8.5) into 0 for absence and 2 for presence. Then, we sum up the `psylvestris_2005_sr` so we have the following values:\n\n-   0 + 0: absent\n\n-   0 + 2: will appear\n\n-   1 + 0: will disappear\n\n-   1 + 2: present\n\nFinally, we convert it to a categorical raster and use a vector of classes (also a vector of colors) to rename it. Let's do this:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Classes and colors for each class\nps_classes <- c(\"Absent\", \"Will disappear\", \"Will appear\",  \"Present and stable\")\nps_colors  <- c(\"#BE92A2\", \"#96031A\", \"#6DA34D\", \"#CEEDDB\")\n## Apply function\npsylvestris_rcp45_sr <- reclassify_rcp(psylvestris_2095_rcp45_sr, ps_classes)\npsylvestris_rcp85_sr <- reclassify_rcp(psylvestris_2095_rcp85_sr, ps_classes)\n```\n:::\n\n\n\nTo verify that it worked correctly, let's create a quick plot:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwith(\n  par(mfrow = c(2, 1)), {\n    plot(psylvestris_rcp45_sr, main = \"RCP 4.5\", col = ps_colors)\n    plot(psylvestris_rcp85_sr, main = \"RCP 8.5\", col = ps_colors)\n  }\n)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\nThe distribution of *Pinus sylvestris* seems correct to me, so let's go to the next step.\n\n::: callout-note\nTake into account that the spatial resolution is 10 km, and we are mapping the potential distribution.\n:::\n\n## Final map\n\nTo create the final map, I will create a function, since we need to apply it to two different objects:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmap_rcp <- function(data, title = \"(a) RCP 4.5\") {\n  \n  ggplot() +\n    geom_spatraster(\n      data = data,\n      show.legend = FALSE\n    ) +\n    scale_fill_manual(\n      values       = ps_colors,\n      labels       = ps_classes,\n      na.value     = NA,\n      na.translate = FALSE\n    ) +\n    labs(\n      title = title\n    ) +\n    theme_void(base_family = \"Roboto\") +\n    theme(\n      plot.title = element_text(\n        face = \"bold\", hjust = .5, color = \"snow\"\n      )\n    )\n  \n}\n```\n:::\n\n\n\nNext, we apply the function to both rasters:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrcp45_gg <- map_rcp(psylvestris_rcp45_sr)\nrcp85_gg <- map_rcp(psylvestris_rcp85_sr, title = \"(b) RCP 8.5\")\n```\n:::\n\n\n\nWe will assemble both maps using `{patchwork}`, but first I will create an appealing title for it. Instead of using a legend, we can use colors in our title to identify the different classes. There's a new R package called `{marquee}` which makes it easier without using HTML, but I found some limitations for long titles when creating line breaks and modifying the line height, so for the moment I will stick with `{ggtext}`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Wrappers for ggtext\nabsent_txt   <- str_glue(\"<b style = 'color: {ps_colors[1]};'>almost absent</b>\")\ndecrease_txt <- str_glue(\"<b style = 'color: {ps_colors[2]};'>decrease</b>\")\nincrease_txt <- str_glue(\"<b style = 'color: {ps_colors[3]};'>shift</b>\")\npresent_txt  <- str_glue(\"<b style = 'color: {ps_colors[4]};'>present</b>\")\n\n## Plot title\ntitle_txt <- str_glue(\n  \"*Pinus sylvestris*, {absent_txt} in southern Europe and {present_txt} in Northern and Central Europe, is<br>\n  projected to {increase_txt} its potential distribution northward and {decrease_txt} in Central Europe under two<br>\n  climatic scenarios by 2095\"\n)\n```\n:::\n\n\n\nThere, I create one label or each class using each of the colors defined before, and put the together in the title. Finally, we can assemble every piece of out plot with `{patchwork}`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrcp45_gg + \n  rcp85_gg +\n  plot_annotation(\n    title   = title_txt,\n    caption = \"Author: Adrián Cidre | https://adrian-cidre.com | Data source: EU-Trees4F\",\n    theme   = theme(\n      text       = element_text(colour = \"snow\"),\n      plot.title = element_markdown(\n        family     = \"Merriweather\",\n        face       = \"bold\",\n        lineheight = 1.2,\n        margin     = margin(t = 5, l = 5)\n      ),\n      plot.caption = element_text(\n        hjust  = .5,\n        family = \"Roboto\"\n      ),\n      plot.background = element_rect(\n        fill = \"gray10\",\n        colour = \"gray10\"\n      )\n    )\n  ) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=902.4}\n:::\n:::\n\n\n\n## Conclusions\n\nCreating a map of the future distribution of European tree species in R is very easy thanks to the EU-Trees4F dataset, and the `{forestdata}` package.\n\nIf you found this post interesting and helpful, please share it with others or create your own, share it and tag me in [linkedin](https://www.linkedin.com/in/adrian-cidre/).\n\n## References {.unnumbered}\n\n::: {#refs}\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}