{
  "hash": "ad703b8aa986398f8f1ed20049677526",
  "result": {
    "markdown": "---\ntitle: \"Thematic map\"\nauthor: \"Adrián Cidre\"\ndate: \"2023-09-29\"\ncategories: [R, spatial, ggplot2]\nimage: \"image.png\"\n\n# Execution \nexecute: \n  warning: false\n---\n\n\n> # Thematic maps with ggplot2\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# install.packages(\"pacman\")\nlibrary(pacman)\n\np_load(\n  ## Core\n  tidyverse,\n  \n  ## Spatial data manipulation\n  sf,\n  \n  ## Download data\n  mapSpain, rnaturalearth,\n  \n  ## Visualization\n  RColorBrewer, ggspatial\n)\n\n# High resolution world map\nremotes::install_github(\"ropensci/rnaturalearthhires\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# World countries\nworld_sf <- ne_countries(\n  scale       = 10,\n  returnclass = \"sf\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get Spanish population by municipality in 2019\nspain_pop_tbl <- mapSpain::pobmun19\n\nhead(spain_pop_tbl)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  cpro provincia cmun      name  pob19   men women\n1   02  Albacete  001 Abengibre    790   379   411\n2   02  Albacete  002    Alatoz    519   291   228\n3   02  Albacete  003  Albacete 173329 84687 88642\n4   02  Albacete  004  Albatana    692   356   336\n5   02  Albacete  005   Alborea    658   337   321\n6   02  Albacete  006  Alcadozo    654   363   291\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get Spain boundaries by municipality\nspain_sf <- esp_get_munic()\n\nhead(spain_sf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 6 features and 7 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -3.14019 ymin: 36.73845 xmax: -2.05701 ymax: 37.54576\nGeodetic CRS:  ETRS89\n    codauto ine.ccaa.name cpro ine.prov.name cmun      name LAU_CODE\n382      01     Andalucía   04       Almería  001      Abla    04001\n379      01     Andalucía   04       Almería  002  Abrucena    04002\n374      01     Andalucía   04       Almería  003      Adra    04003\n375      01     Andalucía   04       Almería  004 Albánchez    04004\n358      01     Andalucía   04       Almería  005 Alboloduy    04005\n373      01     Andalucía   04       Almería  006     Albox    04006\n                          geometry\n382 POLYGON ((-2.77744 37.23836...\n379 POLYGON ((-2.88984 37.09213...\n374 POLYGON ((-2.93161 36.75079...\n375 POLYGON ((-2.13138 37.29959...\n358 POLYGON ((-2.70077 37.09674...\n373 POLYGON ((-2.15335 37.54576...\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Join population to sf object\nspain_pop_sf <- right_join(\n  spain_sf,\n  spain_pop_tbl,\n  by = join_by(cpro, cmun)\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Ratio men-women\nspain_pop_ready_sf <- spain_pop_sf %>% \n  mutate(ratio_mw = men/women)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define the breaks (bin edges) based on percentiles\nbreaks <- quantile(spain_pop_ready_sf$pob19, probs = seq(0, 1, by = 0.1))\n\n# Round to hundred, and keep unique values\nbreaks <- round(breaks, -2) %>% unique()\nbreaks[length(breaks)] <- breaks[length(breaks)] + 100\n\n# Create bins\nspain_pop_ready_sf <- spain_pop_ready_sf %>% \n  mutate(\n    pop_bin = cut(pob19, breaks = breaks, dig.lab = 10)\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot the population\nggplot(spain_pop_ready_sf) + \n  ## Geometries\n  geom_sf(data = world_sf, fill = \"grey90\", color = \"black\") +\n  geom_sf(aes(fill = pop_bin), color = NA) +\n  ## Scales\n  scale_fill_brewer(palette = \"RdBu\", na.translate = FALSE, direction = -1) +\n  ## Labels\n  labs(\n    title   = \"Spanish Population by Municipality\",\n    fill    = \"Population\",\n    caption = \"Author: Adrián Cidre González\"\n  ) +\n  ## Coordinates\n  coord_sf(xlim = st_bbox(spain_pop_ready_sf)[c(1,3)],\n           ylim = st_bbox(spain_pop_ready_sf)[c(2,4)]) +\n  ## Theme\n  theme_bw() +\n  theme(\n    plot.title = element_text(hjust = 0.5, size = 16, face = \"bold\"),\n    legend.background = element_rect(color = \"black\")\n  ) +\n  ## Ggspatial\n  annotation_scale(location = \"br\") +\n  annotation_north_arrow(location = \"tr\", which_north = \"true\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define the breaks (bin edges) based on percentiles\nbreaks <- quantile(spain_pop_ready_sf$ratio_mw, probs = seq(0, 1, by = 0.1))\n\n# Round to hundred, and keep unique values\nbreaks <- round(breaks, 2) %>% unique()\n\n# Create bins\nspain_pop_ready_sf <- spain_pop_ready_sf %>% \n  mutate(\n    ratio_bin = cut(ratio_mw, breaks = breaks)\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot the population\nggplot(spain_pop_ready_sf) + \n  ## Geometries\n  geom_sf(data = world_sf, fill = \"grey90\", color = \"black\") +\n  geom_sf(aes(fill = ratio_bin), color = NA) +\n  ## Scales\n  scale_fill_brewer(palette = \"RdBu\", na.translate = FALSE, direction = -1) +\n  ## Labels\n  labs(\n    title   = \"Men/Women ratio\",\n    fill    = \"Ratio\",\n    caption = \"Author: Adrián Cidre González\"\n  ) +\n  ## Coordinates\n  coord_sf(xlim = st_bbox(spain_pop_ready_sf)[c(1,3)],\n           ylim = st_bbox(spain_pop_ready_sf)[c(2,4)]) +\n  ## Theme\n  theme_bw() +\n  theme(\n    plot.title = element_text(hjust = 0.5, size = 16, face = \"bold\"),\n    legend.background = element_rect(color = \"black\")\n  ) +\n  ## Ggspatial\n  annotation_scale(location = \"br\") +\n  annotation_north_arrow(location = \"tr\", which_north = \"true\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}