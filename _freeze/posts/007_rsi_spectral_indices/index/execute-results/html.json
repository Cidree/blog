{
  "hash": "58229a3d7dc672be50f289301c66a9c5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"NDVI and NDVI in Tenerife before huge wildire\"\ndescription: \"Download satellite images from Sentinel-2, calculate the NDVI and NDMI indices, and generate a couple of maps.\"\ndate: \"2024-06-30\"\ncategories: [remote sensing, ggplot2, R, spatial]\nimage: \"image.png\"\nbibliography: references.bib\nexecute: \n  warning: false\neditor_options: \n  chunk_output_type: console\n---\n\n{{< video https://www.youtube.com/watch?v=mG4MMSgMfZs >}}\n\n\n\n\n## Introduction\n\nIn this post, we will create a map of the Normalized Difference Vegetation Index (NDVI) and the Normalized Difference Moisture Index (NDMI) for the Tenerife Island, using the average between the 2023-07-15 and 2023-08-15, one month before the wildfire that burned around 15,000 hectares.\n\nWe will use the awesome `{rsi}` package [@rsi] to access the Sentinel-2 imagery and calculate the indices. This package is used to retrieve data from different STAC servers that provides satellite imagery. It is also possible to use this package to easily get data from Sentinel-1 and Landsat.\n\nTherefore, in this exercise, we will see how was the value of the indices in average one month before the wildfire of Tenerife.\n\n## Loading packages\n\nWe will use the following packages:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Load pacman\nlibrary(pacman)\n\n## Load rest of the packages\np_load(\n  giscoR, mapview, patchwork, sf, rsi, terra, tidyterra, tidyverse\n)\n```\n:::\n\n\n\nWe will use the `{giscoR}` package to download the boundaries of the Tenerife Island, the `{rsi}` package to retrieve the Sentinel-2 data and to calculate the indices, the `{sf}` package to manipulate vectorial data, the `{terra}` package to manipulate raster data, `{mapview}` for interactive visualizations, `{patchwork}` for plots assembling, and `{tidyterra}` for easy visualizations of `SpatRasters`.\n\n## Load the data\n\nIn this exercise we need to download two sources of data:\n\n-   Study area\n\n-   Satellite image\n\n### Study area\n\nThe study area in this case is the Tenerife Island. We can easily load it into R using the `{giscoR}` package:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Get study area\ntenerife_sf <- gisco_get_nuts(\n  country    = \"Spain\",\n  resolution = \"01\",\n  nuts_level = 3\n) |> \n  filter(\n    NAME_LATN == \"Tenerife\"\n  ) |> \n  st_transform(25828)\n```\n:::\n\n\n\nFirst, we download the Spanish provinces, then we filter only Tenerife, and finally we transform the data to a different coordinates reference system.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapview(tenerife_sf)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-f3687e3082b44d20a4ad\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-f3687e3082b44d20a4ad\">{\"x\":{\"options\":{\"minZoom\":1,\"maxZoom\":52,\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}},\"preferCanvas\":false,\"bounceAtZoomLimits\":false,\"maxBounds\":[[[-90,-370]],[[90,370]]]},\"calls\":[{\"method\":\"addProviderTiles\",\"args\":[\"CartoDB.Positron\",\"CartoDB.Positron\",\"CartoDB.Positron\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"addProviderTiles\",\"args\":[\"CartoDB.DarkMatter\",\"CartoDB.DarkMatter\",\"CartoDB.DarkMatter\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"addProviderTiles\",\"args\":[\"OpenStreetMap\",\"OpenStreetMap\",\"OpenStreetMap\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"addProviderTiles\",\"args\":[\"Esri.WorldImagery\",\"Esri.WorldImagery\",\"Esri.WorldImagery\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"addProviderTiles\",\"args\":[\"OpenTopoMap\",\"OpenTopoMap\",\"OpenTopoMap\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"createMapPane\",\"args\":[\"polygon\",420]},{\"method\":\"addPolygons\",\"args\":[[[[{\"lng\":[-16.133913,-16.136487,-16.157964,-16.172158,-16.192931,-16.22416,-16.242808,-16.25810299999999,-16.270769,-16.274479,-16.284923,-16.289722,-16.298955,-16.306894,-16.315008,-16.320098,-16.325524,-16.332404,-16.335365,-16.344909,-16.365616,-16.383959,-16.410894,-16.420522,-16.430587,-16.443352,-16.444811,-16.455518,-16.455549,-16.45764,-16.465863,-16.473424,-16.471156,-16.474799,-16.487697,-16.496039,-16.503174,-16.523208,-16.554079,-16.56092900000001,-16.570713,-16.588352,-16.59752,-16.602983,-16.624347,-16.636582,-16.643498,-16.6525,-16.659583,-16.673734,-16.677522,-16.684181,-16.694307,-16.695946,-16.703848,-16.718922,-16.726729,-16.733091,-16.738733,-16.751228,-16.762105,-16.768024,-16.793016,-16.797436,-16.810021,-16.829803,-16.848964,-16.861305,-16.86883,-16.872188,-16.881097,-16.895337,-16.903928,-16.916232,-16.923716,-16.920886,-16.905653,-16.89785299999999,-16.894165,-16.881829,-16.879703,-16.871763,-16.862515,-16.859725,-16.852604,-16.84956200000001,-16.841296,-16.838485,-16.844999,-16.84016399999999,-16.835788,-16.81938,-16.808698,-16.802011,-16.772821,-16.76236,-16.757767,-16.738459,-16.733352,-16.736235,-16.712449,-16.705729,-16.707236,-16.702681,-16.68125,-16.667349,-16.663658,-16.650213,-16.644572,-16.638414,-16.632461,-16.62506900000001,-16.597627,-16.558204,-16.549654,-16.545102,-16.540669,-16.540942,-16.53444,-16.531623,-16.524215,-16.520768,-16.507818,-16.503454,-16.49325499999999,-16.489729,-16.48082,-16.471186,-16.463383,-16.462636,-16.450682,-16.448529,-16.44346,-16.439766,-16.432873,-16.426646,-16.426756,-16.433919,-16.431675,-16.425825,-16.42938999999999,-16.427685,-16.423439,-16.424063,-16.409646,-16.408741,-16.408991,-16.407495,-16.388019,-16.383374,-16.362517,-16.360016,-16.362953,-16.36639899999999,-16.369377,-16.359948,-16.337434,-16.332327,-16.320454,-16.307642,-16.28006,-16.269669,-16.25810299999999,-16.249758,-16.246271,-16.244957,-16.235041,-16.196853,-16.185881,-16.17914499999999,-16.166591,-16.154907,-16.145569,-16.135322,-16.126611,-16.129207,-16.127301,-16.120392,-16.12726,-16.133913],\"lat\":[28.574999,28.582362,28.58809,28.584228,28.57384199999999,28.565775,28.571174,28.570687,28.57643599999999,28.572269,28.57583499999999,28.571413,28.569756,28.573321,28.571707,28.577748,28.577537,28.5717,28.55727899999999,28.55604,28.546224,28.546079,28.52740999999999,28.517498,28.487358,28.480255,28.47572899999999,28.46913899999999,28.46603,28.459702,28.45903299999999,28.454254,28.44835800000001,28.443233,28.43774000000001,28.43898,28.42514199999999,28.4176,28.418368,28.412218,28.408298,28.39865,28.399796,28.39431099999999,28.396099,28.394791,28.39810799999999,28.39568899999999,28.400824,28.40030399999999,28.39328699999999,28.391302,28.39488,28.38787399999999,28.38388399999999,28.38704299999999,28.377014,28.381564,28.38041099999999,28.37163200000001,28.375405,28.37369499999999,28.37484299999999,28.377567,28.37749499999999,28.39233999999999,28.387274,28.376423,28.375636,28.371629,28.36825799999999,28.363691,28.36473599999999,28.36130399999999,28.35185999999999,28.34197199999999,28.33791299999999,28.331818,28.322638,28.313188,28.302988,28.29871,28.28762699999999,28.275804,28.27314699999999,28.268041,28.263483,28.257242,28.239535,28.22693599999999,28.2075,28.18209999999999,28.175026,28.156515,28.113896,28.109537,28.10102499999999,28.087556,28.06616899999999,28.054503,28.04648999999999,28.027738,28.010509,28.00535399999999,27.99829,28.00424999999999,28.00839599999999,28.00692400000001,28.003943,28.00895999999999,28.009984,28.017833,28.027754,28.031155,28.02574199999999,28.02608499999999,28.03126,28.041802,28.04369999999999,28.049005,28.05213399999999,28.058685,28.06759899999999,28.07629,28.079317,28.08996699999999,28.09653600000001,28.10886699999999,28.113078,28.120124,28.128383,28.134127,28.13554,28.142277,28.142555,28.148656,28.15162799999999,28.15725999999999,28.163493,28.16700299999999,28.175385,28.188208,28.193653,28.205308,28.226237,28.22792199999999,28.23063599999999,28.23390899999999,28.264273,28.28454399999999,28.304689,28.31853099999999,28.330202,28.33966999999999,28.354086,28.37859499999999,28.396286,28.40102499999999,28.40190800000001,28.40987700000001,28.434466,28.447496,28.452827,28.45584599999999,28.46008399999999,28.474245,28.485833,28.498839,28.509592,28.5105,28.518755,28.52267299999999,28.521773,28.53381899999999,28.532817,28.536953,28.54667599999999,28.555167,28.570296,28.574999]}],[{\"lng\":[-16.158802,-16.161364,-16.162743,-16.158624,-16.157755,-16.158802],\"lat\":[28.595403,28.594775,28.59211999999999,28.589527,28.593144,28.595403]}],[{\"lng\":[-16.761834,-16.765424,-16.76125,-16.759891,-16.761834],\"lat\":[28.38267199999999,28.378954,28.376413,28.38043799999999,28.38267199999999]}]]],null,\"tenerife_sf\",{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}},\"pane\":\"polygon\",\"stroke\":true,\"color\":\"#333333\",\"weight\":0.5,\"opacity\":0.9,\"fill\":true,\"fillColor\":\"#6666FF\",\"fillOpacity\":0.6,\"smoothFactor\":1,\"noClip\":false},\"<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\\/td><th><b>Feature ID&emsp;<\\/b><\\/th><td>1&emsp;<\\/td><\\/tr><tr><td>1<\\/td><th>LEVL_CODE&emsp;<\\/th><td>3&emsp;<\\/td><\\/tr><tr><td>2<\\/td><th>NUTS_ID&emsp;<\\/th><td>ES709&emsp;<\\/td><\\/tr><tr><td>3<\\/td><th>URBN_TYPE&emsp;<\\/th><td>1&emsp;<\\/td><\\/tr><tr><td>4<\\/td><th>CNTR_CODE&emsp;<\\/th><td>ES&emsp;<\\/td><\\/tr><tr><td>5<\\/td><th>NAME_LATN&emsp;<\\/th><td>Tenerife&emsp;<\\/td><\\/tr><tr><td>6<\\/td><th>NUTS_NAME&emsp;<\\/th><td>Tenerife&emsp;<\\/td><\\/tr><tr><td>7<\\/td><th>MOUNT_TYPE&emsp;<\\/th><td>3&emsp;<\\/td><\\/tr><tr><td>8<\\/td><th>COAST_TYPE&emsp;<\\/th><td>1&emsp;<\\/td><\\/tr><tr><td>9<\\/td><th>FID&emsp;<\\/th><td>ES709&emsp;<\\/td><\\/tr><tr><td>10<\\/td><th>geo&emsp;<\\/th><td>ES709&emsp;<\\/td><\\/tr><tr><td>11<\\/td><th>geometry&emsp;<\\/th><td>sfc_MULTIPOLYGON&emsp;<\\/td><\\/tr><\\/table><\\/div>\",{\"maxWidth\":800,\"minWidth\":50,\"autoPan\":true,\"keepInView\":false,\"closeButton\":true,\"closeOnClick\":true,\"className\":\"\"},\"1\",{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},{\"stroke\":true,\"weight\":1,\"opacity\":0.9,\"fillOpacity\":0.84,\"bringToFront\":false,\"sendToBack\":false}]},{\"method\":\"addScaleBar\",\"args\":[{\"maxWidth\":100,\"metric\":true,\"imperial\":true,\"updateWhenIdle\":true,\"position\":\"bottomleft\"}]},{\"method\":\"addHomeButton\",\"args\":[-16.923716,27.99829,-16.120392,28.595403,true,\"tenerife_sf\",\"Zoom to tenerife_sf\",\"<strong> tenerife_sf <\\/strong>\",\"bottomright\"]},{\"method\":\"addLayersControl\",\"args\":[[\"CartoDB.Positron\",\"CartoDB.DarkMatter\",\"OpenStreetMap\",\"Esri.WorldImagery\",\"OpenTopoMap\"],\"tenerife_sf\",{\"collapsed\":true,\"autoZIndex\":true,\"position\":\"topleft\"}]},{\"method\":\"addLegend\",\"args\":[{\"colors\":[\"#6666FF\"],\"labels\":[\"tenerife_sf\"],\"na_color\":null,\"na_label\":\"NA\",\"opacity\":1,\"position\":\"topright\",\"type\":\"factor\",\"title\":\"\",\"extra\":null,\"layerId\":null,\"className\":\"info legend\",\"group\":\"tenerife_sf\"}]}],\"limits\":{\"lat\":[27.99829,28.595403],\"lng\":[-16.923716,-16.120392]},\"fitBounds\":[27.99829,-16.923716,28.595403,-16.120392,[]]},\"evals\":[],\"jsHooks\":{\"render\":[{\"code\":\"function(el, x, data) {\\n  return (\\n      function(el, x, data) {\\n      // get the leaflet map\\n      var map = this; //HTMLWidgets.find('#' + el.id);\\n      // we need a new div element because we have to handle\\n      // the mouseover output separately\\n      // debugger;\\n      function addElement () {\\n      // generate new div Element\\n      var newDiv = $(document.createElement('div'));\\n      // append at end of leaflet htmlwidget container\\n      $(el).append(newDiv);\\n      //provide ID and style\\n      newDiv.addClass('lnlt');\\n      newDiv.css({\\n      'position': 'relative',\\n      'bottomleft':  '0px',\\n      'background-color': 'rgba(255, 255, 255, 0.7)',\\n      'box-shadow': '0 0 2px #bbb',\\n      'background-clip': 'padding-box',\\n      'margin': '0',\\n      'padding-left': '5px',\\n      'color': '#333',\\n      'font': '9px/1.5 \\\"Helvetica Neue\\\", Arial, Helvetica, sans-serif',\\n      'z-index': '700',\\n      });\\n      return newDiv;\\n      }\\n\\n\\n      // check for already existing lnlt class to not duplicate\\n      var lnlt = $(el).find('.lnlt');\\n\\n      if(!lnlt.length) {\\n      lnlt = addElement();\\n\\n      // grab the special div we generated in the beginning\\n      // and put the mousmove output there\\n\\n      map.on('mousemove', function (e) {\\n      if (e.originalEvent.ctrlKey) {\\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\\n      lnlt.text(\\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\\n                           ' | zoom: ' + map.getZoom() +\\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\\n                           ' | epsg: 3857 ' +\\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\\n      } else {\\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\\n      lnlt.text(\\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\\n                      ' | zoom: ' + map.getZoom() + ' ');\\n      }\\n      });\\n\\n      // remove the lnlt div when mouse leaves map\\n      map.on('mouseout', function (e) {\\n      var strip = document.querySelector('.lnlt');\\n      if( strip !==null) strip.remove();\\n      });\\n\\n      };\\n\\n      //$(el).keypress(67, function(e) {\\n      map.on('preclick', function(e) {\\n      if (e.originalEvent.ctrlKey) {\\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\\n      lnlt.text(\\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\\n                      ' | zoom: ' + map.getZoom() + ' ');\\n      var txt = document.querySelector('.lnlt').textContent;\\n      console.log(txt);\\n      //txt.innerText.focus();\\n      //txt.select();\\n      setClipboardText('\\\"' + txt + '\\\"');\\n      }\\n      });\\n\\n      }\\n      ).call(this.getMap(), el, x, data);\\n}\",\"data\":null},{\"code\":\"function(el, x, data) {\\n  return (function(el,x,data){\\n           var map = this;\\n\\n           map.on('keypress', function(e) {\\n               console.log(e.originalEvent.code);\\n               var key = e.originalEvent.code;\\n               if (key === 'KeyE') {\\n                   var bb = this.getBounds();\\n                   var txt = JSON.stringify(bb);\\n                   console.log(txt);\\n\\n                   setClipboardText('\\\\'' + txt + '\\\\'');\\n               }\\n           })\\n        }).call(this.getMap(), el, x, data);\\n}\",\"data\":null}]}}</script>\n```\n\n:::\n:::\n\n\n\n::: note\nThe CRS that you use must be a projected system in meters, since this is required by the `{rsi}` package.\n:::\n\n### Satellite image\n\nWe want to download an image from the Sentinel-2 imagery for the study area that we defined previously. Each Sentinel-2 image contains a total of 12 different bands (variables). However, for our analysis we don't need all of them. The `{rsi}` package makes it easy for us to just download the bands that we need for our analysis. The next dataset contains information about the bands, and it can be used to filter the desired bands:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsentinel2_band_mapping$planetary_computer_v1\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAn rsi band mapping object with attributes:\nnames mask_band mask_function stac_source collection_name query_function class scl_name download_function sign_function\n\n  B01   B02   B03   B04   B05   B06   B07   B08   B8A   B09   B11   B12 \n  \"A\"   \"B\"   \"G\"   \"R\" \"RE1\" \"RE2\" \"RE3\"   \"N\"  \"N2\"  \"WV\"  \"S1\"  \"S2\" \n```\n\n\n:::\n:::\n\n\n\nThis is essentially a character vector, so we will filter the RGB bands plus the NIR and SWIR1 that we need to calculate the indices:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsel_bands <- sentinel2_band_mapping$planetary_computer_v1[c(\"B02\", \"B03\", \"B04\", \"B08\", \"B11\")]\n\nsel_bands\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAn rsi band mapping object with attributes:\nmask_band mask_function stac_source collection_name query_function class scl_name download_function sign_function names\n\n B02  B03  B04  B08  B11 \n \"B\"  \"G\"  \"R\"  \"N\" \"S1\" \n```\n\n\n:::\n:::\n\n\n\nNow that we have the bands that we need, we can use the `rsi::get_sentinel2_imagery()` function to retrieve the satellite image. Here, we will specify the arguments:\n\n-   **aoi**: area of interest\n\n-   **start_date**: initial date for retrieving images\n\n-   **end_date**: end data for retrieving images\n\n-   **asset_names**: the rsi band mapping object with the desired bands\n\n-   **output_filename**: output where the image will be downloaded. In this case, I just save it to the temporary directory.\n\nNote that there is one argument called `composite_function = \"median\"`, which mean that the images between start and end date will be reduced to the median. So now, it's time to get out image:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntenerife_s2 <- get_sentinel2_imagery(\n  aoi             = tenerife_sf,\n  start_date      = \"2023-07-15\",\n  end_date        = \"2023-08-15\",\n  asset_names     = sel_bands,\n  output_filename = glue::glue(\"{tempdir()}/sentinel.tif\")\n)\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\nThe images are stored in the cloud after multiplying them by a factor of 10,000 to avoid the storage of floats. Therefore, we will apply back this factor to get the real digital values:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntenerife_sr <- rast(tenerife_s2) / 10000\n```\n:::\n\n\n\nBefore calculating the indices, we can check how does it look the RGB image:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotRGB(\n  tenerife_sr,\n  3, 2, 1,\n  scale   = 2,\n  stretch = \"lin\"\n)\n```\n\n::: {.cell-output-display}\n![RGB image of Tenerife, averaged from 15th July 2023 to 15th July 2023. Source: Sentinel-2](index_files/figure-html/fig-rgb-tenerife-1.png){#fig-rgb-tenerife width=672}\n:::\n:::\n\n\n\n## Data preparation\n\nBefore proceeding with the analysis, I just want to get the indices for the Island, not for the sea. I mean, as you can see in @fig-rgb-tenerife, the image is a rectangle where we also have the sea. To eliminate these pixels, we can mask those values as follows:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntenerife_sr <- mask(tenerife_sr, tenerife_sf)\n```\n:::\n\n\n\nWe are basically converting to NA the values of `tenerife_sr` which are outside of `tenerife_sf`. Excellent!! Let's go to calculate the indices.\n\n### Select indices\n\nWe could manually calculate the indices, since it's very simple. However, I want to show you something from the `{rsi}` package that really stands out! We have access to the [awesome spectral indices](https://github.com/awesome-spectral-indices/awesome-spectral-indices) database through the `{spectral_indices}` function.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspectral_indices()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 243 × 9\n   application_domain bands     contributor   date_of_addition formula long_name\n   <chr>              <list>    <chr>         <chr>            <chr>   <chr>    \n 1 vegetation         <chr [2]> https://gith… 2021-11-17       (N - 0… Aerosol …\n 2 vegetation         <chr [2]> https://gith… 2021-11-17       (N - 0… Aerosol …\n 3 water              <chr [6]> https://gith… 2022-09-22       (B + G… Augmente…\n 4 vegetation         <chr [2]> https://gith… 2021-09-20       (1 / G… Anthocya…\n 5 vegetation         <chr [3]> https://gith… 2022-04-08       N * ((… Anthocya…\n 6 vegetation         <chr [4]> https://gith… 2021-05-11       (N - (… Atmosphe…\n 7 vegetation         <chr [4]> https://gith… 2021-05-14       sla * … Adjusted…\n 8 vegetation         <chr [2]> https://gith… 2022-04-08       (N * (… Advanced…\n 9 water              <chr [4]> https://gith… 2021-09-18       4.0 * … Automate…\n10 water              <chr [5]> https://gith… 2021-09-18       B + 2.… Automate…\n# ℹ 233 more rows\n# ℹ 3 more variables: platforms <list>, reference <chr>, short_name <chr>\n```\n\n\n:::\n:::\n\n\n\nA total of 243 indices that can be calculated 😱. Honestly, I don't know most of them and I think for a tutorial like this one is enough to showcase two of them. So we can filter them from that `tibble` using a regular filter:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindices_tbl <- spectral_indices() |> \n  filter(\n    short_name %in% c(\"NDMI\", \"NDVI\")\n  )\n\nindices_tbl\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 9\n  application_domain bands     contributor    date_of_addition formula long_name\n  <chr>              <list>    <chr>          <chr>            <chr>   <chr>    \n1 vegetation         <chr [2]> https://githu… 2021-12-01       (N - S… Normaliz…\n2 vegetation         <chr [2]> https://githu… 2021-04-07       (N - R… Normaliz…\n# ℹ 3 more variables: platforms <list>, reference <chr>, short_name <chr>\n```\n\n\n:::\n:::\n\n\n\n### Calculate indices\n\nOnce we filtered the indices we want in the `spectral_indices()` table, we can use the `calculate_indices()` function to obtain them. And this is very straightforward, you just need the image, the filtered indices in the table, and specify the output file name.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Calculate indices\nindices_path <- calculate_indices(\n  raster          = tenerife_sr,\n  indices         = indices_tbl,\n  output_filename = glue::glue(\"{tempdir()}/spectral_indices.tif\")\n)\n\n## Read indices\nindices_sr <- rast(indices_path)\n\n## Print\nindices_sr\n```\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 6556, 7895, 2  (nrow, ncol, nlyr)\nresolution  : 10, 10  (x, y)\nextent      : 311453.7, 390403.7, 3098149, 3163709  (xmin, xmax, ymin, ymax)\ncoord. ref. : ETRS89 / UTM zone 28N (EPSG:25828) \nsource      : 007_indices.tif \nnames       :       NDMI,       NDVI \nmin values  : -0.5467158, -0.5689685 \nmax values  :  0.6188195,  0.7418026 \n```\n\n\n:::\n:::\n\n\n\nAs you can see, we have a `SpatRaster` with two bands, one per index.\n\n### Classify NDMI\n\nInstead of showing the NDMI as a continuous variable, we can classify it using some thresholds. In this case, I followed the recommendations given my [EOS Data Analytics](https://eos.com/make-an-analysis/ndmi/) slightly modified. We can have a look at the histograms of these two variables:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(indices_sr)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\nThere are almost no values in the tails, so I decided to reduce the classification for this exercise to the following 5 classes:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Classification matrix for NDMI\nndmi_mat <- matrix(\n  c(\n    -Inf, -.2, 1,\n    -.2, 0, 2,\n    0, .2, 3,\n    .2, .4, 4,\n    .4, Inf, 5\n  ),\n  ncol  = 3,\n  byrow = TRUE\n)\n\n## Classify NDMI\nindices_sr$NDMI <- indices_sr$NDMI |> \n  classify(\n    rcl = ndmi_mat\n  ) |> \n  as.factor()\n\n## Label values\nlevels(indices_sr$NDMI)[[1]][, 2] <- c(\n  \"Low or very low canopy cover, dry or very low canopy cover, wet\",\n  \"Mid-low canopy cover, high water stress or low canopy cover, low water stress\",\n  \"Average canopy cover, high water stress or mid-low canopy cover, low water stress\",\n  \"Mid-high canopy cover, high water stress or average canopy cover, low water stress\",\n  \"No water stress\"\n)\n```\n:::\n\n\n\n## Visualize\n\nThe last step in this analysis is to create a map. We create two maps independently, and then assemble them together using the `patchwork` package:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nndmi_gg <- ggplot() +\n  geom_spatraster(\n    data = indices_sr$NDMI\n  ) +\n  scale_fill_whitebox_d(\n    palette   = \"bl_yl_rd\",\n    direction = -1\n  ) +\n  guides(\n    fill = guide_legend(\n      position = \"inside\",\n      title    = NULL\n    )\n  ) +\n  theme_void(\n    base_size   = 8,\n    base_family = \"Roboto\"\n  ) +\n  theme(\n    legend.position.inside = c(.3, .8),\n    legend.key.spacing.y   = unit(2, \"mm\"),\n    legend.key.width       = unit(5, \"mm\"),\n    legend.key.height      = unit(1, \"mm\"),\n    legend.key             = element_rect(colour = \"black\", linewidth = .2),\n    legend.text            = element_text(size = 5),\n  )\n\nndmi_gg\n```\n\n::: {.cell-output-display}\n![Normalized Difference Moisture Index reduced into 5 classes](index_files/figure-html/fig-ndmi-1.png){#fig-ndmi width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nndvi_gg <- ggplot() +\n  geom_spatraster(\n    data = indices_sr$NDVI\n  ) +\n  scale_fill_whitebox_c(\n    palette   = \"muted\",\n    direction = -1\n  ) +\n  guides(\n    fill = guide_colorbar(\n      position       = \"inside\",\n      title          = \"NDVI\",\n      title.position = \"top\",\n      title.hjust    = .5,\n      direction      = \"horizontal\"\n    )\n  ) +\n  theme_void(\n    base_size   = 8,\n    base_family = \"Roboto\"\n  ) +\n  theme(\n    legend.position.inside = c(.3, .8),\n    legend.key.width       = unit(1, \"cm\"),\n    legend.key.height      = unit(1.5, \"mm\"),\n    legend.text            = element_text(size = 5),\n    legend.title           = element_text(size = 8)\n  )\n\nndvi_gg\n```\n\n::: {.cell-output-display}\n![Normalized Difference Vegetation Index](index_files/figure-html/fig-ndvi-1.png){#fig-ndvi width=672}\n:::\n:::\n\n\n\nSo the final visualization is created with `patchwork` as follows:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nndvi_gg + \n  ndmi_gg +\n    plot_annotation(\n      title    = \"Pre-Wildfire Vegetation and Moisture Analysis of Tenerife\",\n      subtitle = \"NDVI and NDMI averaged from 15-July 2023 to 15-August 2023\",\n      caption  = \"Author: Adrián Cidre | https://adrian-cidre.com | Data source: Sentinel-2\",\n      theme    = theme(\n        plot.title = element_text(\n          family     = \"Merriweather\",\n          face       = \"bold\",\n          lineheight = 1.2,\n          margin     = margin(t = 5, l = 5, b = 10),\n          hjust = .5\n        ),\n        plot.subtitle = element_text(hjust = .5),\n        plot.caption  = element_text(\n          hjust  = .5,\n          family = \"Roboto\"\n        )\n      )\n    ) \n```\n\n::: {.cell-output-display}\n![Final visualization with NDMI and NDVI assembled with the {patchwork} package](index_files/figure-html/fig-final-1.png){#fig-final width=960}\n:::\n:::\n\n\n\n## Conclusions\n\nUsing the `{rsi}` package is very easy to retrieve satellite images from different sources. In this exercise, we saw how to obtain a Sentinel-2 image for a given area, and we calculated two spectral indices using the same package.\n\nIf you found this post interesting and helpful, please share it with others or create your own, and tag me in [linkedin](https://www.linkedin.com/in/adrian-cidre/). You can also watch the video in YouTube to learn more.\n\n## References {.unnumbered}\n\n::: {#refs}\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-binding-2.2.2/leaflet.js\"></script>\n<script src=\"../../site_libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js\"></script>\n<script src=\"../../site_libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js\"></script>\n<link href=\"../../site_libs/HomeButton-0.0.1/home-button.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/HomeButton-0.0.1/home-button.js\"></script>\n<script src=\"../../site_libs/HomeButton-0.0.1/easy-button-src.min.js\"></script>\n<script src=\"../../site_libs/clipboard-0.0.1/setClipboardText.js\"></script>\n<link href=\"../../site_libs/mapviewCSS-0.0.1/mapview-popup.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/mapviewCSS-0.0.1/mapview.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}