<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Adrián Cidre">
<meta name="dcterms.date" content="2024-01-07">
<title>Adrián Cidre - 3D Population Spikes Map - Norway</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-J58431JK0F"></script><script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-J58431JK0F', { 'anonymize_ip': true});
</script><script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"interstitial",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script><link rel="stylesheet" href="../../00_styles/styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Adrián Cidre</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../courses.html" rel="" target="">
 <span class="menu-text">Courses</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Cidree" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/adrian-cidre-gonz%C3%A1lez-8a50371b0/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:adrian.cidre@gmail.com" rel="" target=""><i class="bi bi-envelope-at" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">3D Population Spikes Map - Norway</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">rayshader</div>
                <div class="quarto-category">spatial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Adrián Cidre </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 7, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of Contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#loading-packages" id="toc-loading-packages" class="nav-link" data-scroll-target="#loading-packages"><span class="header-section-number">2</span> Loading packages</a></li>
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data"><span class="header-section-number">3</span> Load the data</a></li>
  <li><a href="#prepare-the-data" id="toc-prepare-the-data" class="nav-link" data-scroll-target="#prepare-the-data"><span class="header-section-number">4</span> Prepare the data</a></li>
  <li>
<a href="#d-visualization" id="toc-d-visualization" class="nav-link" data-scroll-target="#d-visualization"><span class="header-section-number">5</span> 3D Visualization</a>
  <ul class="collapse">
<li><a href="#base-3d-plot" id="toc-base-3d-plot" class="nav-link" data-scroll-target="#base-3d-plot"><span class="header-section-number">5.1</span> Base 3D plot</a></li>
  <li><a href="#render-camera" id="toc-render-camera" class="nav-link" data-scroll-target="#render-camera"><span class="header-section-number">5.2</span> Render camera</a></li>
  <li><a href="#render-in-high-quality" id="toc-render-in-high-quality" class="nav-link" data-scroll-target="#render-in-high-quality"><span class="header-section-number">5.3</span> Render in high quality</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><section id="introduction" class="level2" data-number="1"><h2 data-number="1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">1</span> Introduction</h2>
<p>In this post, we will create an amazing spikes population map for the country of Noway using the awesome <code>rayshader</code> R package.</p>
<p>I will use data from the <a href="https://www.kontur.io/">Kontur database</a>, which has a <a href="https://www.kontur.io/portfolio/population-dataset/">population density dataset</a> where the world population is represented by H3 hexagons with a spatial resolution of 400 meters.</p>
</section><section id="loading-packages" class="level2" data-number="2"><h2 data-number="2" class="anchored" data-anchor-id="loading-packages">
<span class="header-section-number">2</span> Loading packages</h2>
<p>If you followed me in other posts or did any of my <a href="https://adrian-cidre.com/courses">courses</a>, you will notice that I always use the <code>pacman</code> package to load the rest of the packages. This is because the <code>p_load</code> function will install any missing packages, and then load them into our R session.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/trinker/pacman">pacman</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="co">## Core</span></span>
<span>  <span class="va">tidyverse</span>,</span>
<span>  </span>
<span>  <span class="co">## Donwload data</span></span>
<span>  <span class="va">httr</span>, <span class="va">R.utils</span>,</span>
<span>  </span>
<span>  <span class="co">## Spatial data</span></span>
<span>  <span class="va">sf</span>, <span class="va">stars</span>, <span class="va">terra</span>,</span>
<span>  </span>
<span>  <span class="co">## Visualization</span></span>
<span>  <span class="va">rayshader</span>, <span class="va">colorspace</span>, <span class="va">MetBrewer</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="load-the-data" class="level2" data-number="3"><h2 data-number="3" class="anchored" data-anchor-id="load-the-data">
<span class="header-section-number">3</span> Load the data</h2>
<p>The data can be directly downloaded from the <a href="https://data.humdata.org/organization/kontur">Kontur website</a>, or we can also copy the url for the country and download it into R directly.</p>
<p>First I create a function that will download the data using <code><a href="https://httr.r-lib.org/reference/GET.html">httr::GET()</a></code>, then it will unzip the <em>gz</em> file with <code><a href="https://henrikbengtsson.github.io/R.utils/reference/compressFile.html">R.utils::gunzip()</a></code>, and finally it will return the file path without the <em>gz</em> extension.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_data_httr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">url</span>, <span class="va">file_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Get url</span></span>
<span>  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span></span>
<span>    <span class="va">url</span>,</span>
<span>    <span class="fu">write_disk</span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co">## Unzip the gz file</span></span>
<span>  <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/compressFile.html">gunzip</a></span><span class="op">(</span><span class="va">file_name</span>, remove <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="co">## Get the file path</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">".gz"</span>, <span class="st">""</span>, <span class="va">file_name</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we apply the funtion by providing the url to the compressed file, and also the file name with the <em>gz</em> extension:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Url</span></span>
<span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://geodata-eu-central-1-kontur-public.s3.amazonaws.com/kontur_datasets/kontur_population_NO_20231101.gpkg.gz"</span></span>
<span><span class="co">## File name</span></span>
<span><span class="va">file_name</span> <span class="op">&lt;-</span> <span class="st">"norway-population.gpkg.gz"</span></span>
<span></span>
<span><span class="co">## Get file path</span></span>
<span><span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu">get_data_httr</span><span class="op">(</span><span class="va">url</span>, <span class="va">file_name</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we downloaded the data, we can read it into R and project it to the Lambert Azimuthal Equal-Area (LAEA) projection:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">population_sf</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">read_sf</span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="st">"EPSG:3035"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">population_sf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 186254 features and 2 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 3629718 ymin: 3876026 xmax: 5132823 ymax: 6391949
Projected CRS: ETRS89-extended / LAEA Europe
# A tibble: 186,254 × 3
   h3              population                                               geom
 * &lt;chr&gt;                &lt;dbl&gt;                                      &lt;POLYGON [m]&gt;
 1 8809abd9b5fffff          2 ((4045387 4292797, 4044957 4292776, 4044823 42923…
 2 8809abd9a7fffff          1 ((4044985 4291569, 4044555 4291547, 4044421 42911…
 3 8809abcf67fffff         66 ((4054799 4300908, 4054370 4300887, 4054237 43004…
 4 8809abcf63fffff          1 ((4054637 4301704, 4054208 4301684, 4054075 43012…
 5 8809abcf2dfffff          2 ((4055524 4300541, 4055095 4300520, 4054961 43001…
 6 8809abcf2bfffff          6 ((4055924 4301767, 4055495 4301746, 4055362 43013…
 7 8809abcf29fffff          6 ((4055362 4301337, 4054933 4301317, 4054799 43009…
 8 8809abcf27fffff          5 ((4056811 4300603, 4056382 4300583, 4056248 43001…
 9 8809abcf25fffff          2 ((4056248 4300174, 4055819 4300153, 4055686 42997…
10 8809abcf21fffff          7 ((4056086 4300970, 4055657 4300950, 4055524 43005…
# ℹ 186,244 more rows</code></pre>
</div>
</div>
<p>The data contains the <em>h3</em> column which is the ID of the h3 hexagon, and the total <em>population</em> within the hexagon.</p>
</section><section id="prepare-the-data" class="level2" data-number="4"><h2 data-number="4" class="anchored" data-anchor-id="prepare-the-data">
<span class="header-section-number">4</span> Prepare the data</h2>
<p>Once we have the population file loaded into R, we need to convert it into a raster. This is because when working with <code>rayshader</code> we need to work with a matrix, and in essence, a raster is a matrix of values.</p>
<p>Therefore, to create the hexagons into a raster, first we need to know the dimensions that we want for our raster. The next function will do the work. First, we get the height and width of the bounding box of our population data. Then we create the ratio variables storing the highest one as 1, and the lowest one as the ratio with the highest:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create function to get width and height</span></span>
<span><span class="va">get_raster_size</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Get height and width in CRS units</span></span>
<span>  <span class="va">height</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="va">bbox</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">width</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">bbox</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co">## Get the ratio between height and width</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">height</span> <span class="op">&gt;</span> <span class="va">width</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">height_ratio</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">width_ratio</span> <span class="op">&lt;-</span> <span class="va">width</span> <span class="op">/</span> <span class="va">height</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">width_ratio</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">height_ratio</span> <span class="op">&lt;-</span> <span class="va">height</span> <span class="op">/</span> <span class="va">width</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    width  <span class="op">=</span> <span class="va">width_ratio</span>, </span>
<span>    height <span class="op">=</span> <span class="va">height_ratio</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Get height and width for my data</span></span>
<span><span class="va">hw_ratio</span> <span class="op">&lt;-</span> <span class="fu">get_raster_size</span><span class="op">(</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">population_sf</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prin it</span></span>
<span><span class="va">hw_ratio</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$width
[1] 0.597437

$height
[1] 1</code></pre>
</div>
</div>
<p>There we see that Norway’s width is about 60% of its height. The next step is to choose the size of the highest dimension (in this case the height). For this example, I chose a size of 2,000 of height which corresponds to 1,194 in width. To clarify, this will determine the number of pixels, and therefore, the spatial resolution. We can then use the <code><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html">stars::st_rasterize()</a></code> function to convert our population file into a raster with the specified size.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">size</span> <span class="op">&lt;-</span> <span class="fl">6000</span></span>
<span></span>
<span><span class="va">population_stars</span> <span class="op">&lt;-</span> <span class="va">population_sf</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">population</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_rasterize</span><span class="op">(</span></span>
<span>    nx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">size</span> <span class="op">*</span> <span class="va">hw_ratio</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,</span>
<span>    ny <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">size</span> <span class="op">*</span> <span class="va">hw_ratio</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>When testing I recommend you to use smaller values of size (e.g.&nbsp;1,000) than when creating the final map (e.g.&nbsp;&gt;5,000)</p>
</div>
</div>
<p>The last step before starting to work with <code>rayshader</code> is to convert the <code>stars</code> object into a matrix. We have the convenient <code>raster_to_matrix()</code> function, but it expects a <code>SpatRaster</code> or <code>RasterLayer</code> as input, so I converted it into a <code>SpatRaster</code> prior to converting it into a matrix:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">population_matrix</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">population_stars</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">raster_to_matrix</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="d-visualization" class="level2" data-number="5"><h2 data-number="5" class="anchored" data-anchor-id="d-visualization">
<span class="header-section-number">5</span> 3D Visualization</h2>
<p>We can finally create our amazing visualization! Let’s define a colour palette first. I will use one that is already in the <code>MetBrewer</code> package:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Define palette</span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu">met.brewer</span><span class="op">(</span><span class="st">"OKeeffe2"</span>, n <span class="op">=</span> <span class="fl">10</span>, <span class="st">"continuous"</span><span class="op">)</span></span>
<span><span class="co">## Define texture</span></span>
<span><span class="va">population_texture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span></span>
<span>  colors <span class="op">=</span> <span class="va">pal</span></span>
<span><span class="op">)</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span></span>
<span><span class="co">## Visualize it</span></span>
<span><span class="fu">swatchplot</span><span class="op">(</span><span class="va">population_texture</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/unnamed-chunk-6-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>To create a 3D visualization with <code>rayshader</code>, the process involves three key steps:</p>
<ul>
<li><p>Create a base 3D plot (moderate time-consuming)</p></li>
<li><p>Readjust some parameters (fast)</p></li>
<li><p>Render our final image with high quality (very time consuming)</p></li>
</ul>
<section id="base-3d-plot" class="level3" data-number="5.1"><h3 data-number="5.1" class="anchored" data-anchor-id="base-3d-plot">
<span class="header-section-number">5.1</span> Base 3D plot</h3>
<p>The first image that we will create takes about 3 minutes to render in my laptop with size = 6000. We will use two functions:</p>
<ul>
<li><p><code>height_shade()</code>: it calculates a colour for each pixel of the raster by using the texture that we defined previously.</p></li>
<li>
<p><code>plot_3d()</code>: uses the result of the <code>height_shade()</code> function to display a 3D map in a RGL window. The most important arguments are:</p>
<ul>
<li><p>Zscale: probably the most important. It’s the ratio between the x and y spacing and the z axis. A lower number will create taller spikes, and it’s dependent of the resolution (the size we specified to create the raster).</p></li>
<li><p>Phi: the azimuth angle in degrees (can be tweaked later).</p></li>
<li><p>Theta: rotation around the z-axis in degrees (can be tweaked later).</p></li>
<li><p>Zoom: the zoom factor from 0 to 1 (can be tweaked later).</p></li>
</ul>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">population_matrix</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">height_shade</span><span class="op">(</span>texture <span class="op">=</span> <span class="va">population_texture</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">plot_3d</span><span class="op">(</span></span>
<span>    heightmap       <span class="op">=</span> <span class="va">population_matrix</span>,</span>
<span>    solid           <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    soliddepth      <span class="op">=</span> <span class="fl">0</span>,      </span>
<span>    zscale          <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    shadowdepth     <span class="op">=</span> <span class="fl">0</span>,      </span>
<span>    shadow_darkness <span class="op">=</span> <span class="fl">.95</span>,    </span>
<span>    windowsize      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">600</span>, <span class="fl">600</span><span class="op">)</span>,</span>
<span>    zoom            <span class="op">=</span> <span class="fl">.6</span>,   </span>
<span>    phi             <span class="op">=</span> <span class="fl">50</span>,    </span>
<span>    theta           <span class="op">=</span> <span class="fl">30</span>,   </span>
<span>    background      <span class="op">=</span> <span class="st">"white"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result appear in a RGL device and looks like <a href="#fig-pop-plot">Figure&nbsp;1</a>. Nothing amazing so far. This is just an interactive device where we can explore our plot.</p>
<div id="fig-pop-plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><a href="figs/01_render.png" class="lightbox" title="Result of plot_3d" data-gallery="quarto-lightbox-gallery-2"><img src="figs/01_render.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">Figure&nbsp;1: Result of plot_3d</figcaption></figure>
</div>
</section><section id="render-camera" class="level3" data-number="5.2"><h3 data-number="5.2" class="anchored" data-anchor-id="render-camera">
<span class="header-section-number">5.2</span> Render camera</h3>
<p>When we have our plot rendered, we can play with the zoom, theta and phi angles by using the <code>render_camera</code> function. This is very convenient because we don’t have to render the plot again, and it will be very fast:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">render_camera</span><span class="op">(</span></span>
<span>  zoom  <span class="op">=</span> <span class="fl">0.35</span>,</span>
<span>  theta <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  phi   <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After playing for a while with the values I decided to keep these values as my final choice, which correspond to the <a href="#fig-pop-camera">Figure&nbsp;2</a>.</p>
<div id="fig-pop-camera" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><a href="figs/02_render.png" class="lightbox" title="Result of render_camera" data-gallery="quarto-lightbox-gallery-3"><img src="figs/02_render.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">Figure&nbsp;2: Result of render_camera</figcaption></figure>
</div>
</section><section id="render-in-high-quality" class="level3" data-number="5.3"><h3 data-number="5.3" class="anchored" data-anchor-id="render-in-high-quality">
<span class="header-section-number">5.3</span> Render in high quality</h3>
<p>When we have our RGL device with our desired map, we can render it to a high quality image.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is very computational expensive, and depending on the specifications of your machine this process may fail for higher resolutions</p>
</div>
</div>
<p>Note that for a size of 2,000 it takes around 5 minutes to run in my computer. However, with a size of 6,000 it takes over 30 minutes. Here I use the function <code>render_quality()</code> with the following arguments:</p>
<ul>
<li><p>Preview: whether or not to preview how the object is rendered (it gives a hint of the remaining time to finish).</p></li>
<li><p>Lightdirection: angle(s) of direction from where the sun is lightening our map.</p></li>
<li><p>Lightaltitude: angle(s) of altitude of the sun from the horizontal surface.</p></li>
<li><p>Lightintensity: intensity of the light(s).</p></li>
<li><p>Lightcolour: colour of the light(s).</p></li>
<li><p>Interactive: whether the scene will be interactive.</p></li>
<li><p>Width and height: defines the resolution of the resulting image.</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">rayshader</span><span class="fu">::</span><span class="fu"><a href="https://www.rayshader.com/reference/render_highquality.html">render_highquality</a></span><span class="op">(</span></span>
<span>  filename       <span class="op">=</span> <span class="st">"norway_spikes_map.png"</span>,</span>
<span>  preview        <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  light          <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  lightdirection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">240</span>, <span class="fl">320</span><span class="op">)</span>,</span>
<span>  lightaltitude  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>, </span>
<span>  lightintensity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">600</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  lightcolor     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">lighten</span><span class="op">(</span><span class="va">pal</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>, <span class="fl">0.75</span><span class="op">)</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>  interactive    <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  width          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">population_stars</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>  height         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">population_stars</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting image (using a size of 6,000 and zscale of 20) is shown in <a href="#fig-spikes-map">Figure&nbsp;3</a>.</p>
<div id="fig-spikes-map" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><a href="figs/norway_crop.png" class="lightbox" title="Spikes population map of Norway" data-gallery="quarto-lightbox-gallery-4"><img src="figs/norway_crop.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">Figure&nbsp;3: Spikes population map of Norway</figcaption></figure>
</div>
<p>We can see that most of the population of Norway in the half south of the country, specially in Viken region. We can also add some labels to the map, so we get the final result in <a href="#fig-spikes-map-labelled">Figure&nbsp;4</a>.</p>
<div id="fig-spikes-map-labelled" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><a href="figs/norway_complete.png" class="lightbox" title="Population spikes map of Norway with labels of some important cities" data-gallery="quarto-lightbox-gallery-5"><img src="figs/norway_complete.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">Figure&nbsp;4: Population spikes map of Norway with labels of some important cities</figcaption></figure>
</div>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://utteranc.es/client.js" repo="Cidree/blogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Made with <a href="https://quarto.org/">Quarto</a></div>   
    <div class="nav-footer-center"><a href="mailto:adrian.cidre@gmail.com">Contact Adrián Cidre</a><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right"><a href="https://github.com/Cidree/blog">Github Code Repo</a></div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","openEffect":"zoom","descPosition":"bottom","selector":".lightbox","loop":true});</script>


</body></html>